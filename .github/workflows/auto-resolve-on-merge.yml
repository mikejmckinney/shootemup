name: Auto-Resolve Conversations on Merge

on:
  pull_request:
    types: [closed]

jobs:
  resolve-on-merge:
    # Only run if the PR was actually merged (not just closed without merging)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Resolve all threads
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "PR #$PR_NUMBER was merged. Resolving outstanding conversations..."

          # 1. Fetch all unresolved thread IDs
          THREAD_IDS=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $pr: Int!) {
              repository(owner: $owner, name: $repo) {
                pullRequest(number: $pr) {
                  reviewThreads(first: 100) {
                    nodes { id isResolved }
                  }
                }
              }
            }' -F owner="${REPO%/*}" -F repo="${REPO#*/}" -F pr=$PR_NUMBER \
            --jq '.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false) | .id')

          # 2. Resolve them
          if [ -z "$THREAD_IDS" ]; then
            echo "No unresolved conversations found."
          else
            echo "$THREAD_IDS" | while read -r thread_id; do
              echo "Resolving thread $thread_id..."
              gh api graphql -f query='
                mutation($threadId: ID!) {
                  resolveReviewThread(input: {threadId: $threadId}) {
                    thread { isResolved }
                  }
                }' -F threadId="$thread_id" > /dev/null
            done
            echo "âœ… All conversations resolved."
          fi
